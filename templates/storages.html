{% extends "layout.html" %}
{% block title %}قائمة المخازن{% endblock %}
{% block content %}
<link href="{{ url_for('static', filename='toolsstyle.css') }}" rel="stylesheet">

<h1>قائمة المخازن</h1>

{% if message %}
    <div class="flash-messages">
        <div class="alert alert-{{ message_type }} mt-3">{{ message }}</div>
    </div>
{% endif %}

<table class="table table-striped table-hover">
    <thead class="thead-dark">
        <tr>
            <th>المعرف</th>
            <th>الاسم</th>
            <th>الموقع</th>
            <th>رابط الموقع</th>
            <th>المسؤول</th>
            <th>العمليات</th>
        </tr>
    </thead>
    <tbody>
        {% for storage in storages %}
        <tr>
            <td>{{ storage.storage_id }}</td>
            <td>{{ storage.name }}</td>
            <td>{{ storage.location }}</td>
            <td><a href="{{ storage.location_url }}" target="_blank">{{ storage.location_url }}</a></td>
            <td>{{ storage.admin_name }}</td>
            <td>
                <button class="btn btn-edit btn-sm" 
                        data-toggle="modal" 
                        data-target="#editModal" 
                        data-id="{{ storage.storage_id }}" 
                        data-name="{{ storage.name }}" 
                        data-location="{{ storage.location }}" 
                        data-location_url="{{ storage.location_url }}"
                        data-admin_id="{{ storage.admin_id }}">
                    تعديل
                </button>
                <a href="{{ url_for('delete_storage', storage_id=storage.storage_id) }}" 
                   class="btn btn-delete btn-sm" 
                   onclick="return confirm('هل أنت متأكد أنك تريد حذف هذا المخزن؟')">
                    حذف
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Edit Storage Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">تعديل المخزن</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editStorageForm" method="POST" action="{{ url_for('update_storage') }}">
                <div class="modal-body">
                    <input type="hidden" name="storage_id" id="edit-id">
                    <div class="form-group">
                        <label for="edit-name">الاسم</label>
                        <input type="text" class="form-control" name="name" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-location">الموقع</label>
                        <input class="form-control" name="location" id="edit-location"></input>
                    </div>
                    <div class="form-group">
                        <label for="edit-location_url">رابط الموقع</label>
                        <input type="url" class="form-control" name="location_url" id="edit-location_url" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-admin_id">المسؤول</label>
                        <select class="form-control" name="admin_id" id="edit-admin_id">
                            {% for admin in admins %}
                                <option value="{{ admin.admin_id }}">{{ admin.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">إغلاق</button>
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    $('#editModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); 
        var id = button.data('id');
        var name = button.data('name');
        var location = button.data('location');
        var location_url = button.data('location_url');
        // var admin_id = button.data('admin_id'); // Remove this line to keep current admin_id

        var modal = $(this);
        modal.find('#edit-id').val(id);
        modal.find('#edit-name').val(name);
        modal.find('#edit-location').val(location);
        modal.find('#edit-location_url').val(location_url);
        // modal.find('#edit-admin_id').val(admin_id); // Remove this line to keep current admin_id
    });
});
</script>
{% endblock %}
